<div class="article">
    <!-- 左侧文章正文（套用 article-main 样式） -->
    <div class="article-main">
        <div>
            <h1>
                <%= page.title %>
            </h1>
            <div class="info">
                <span class="date">
                    <span class="icon">
                        <i class="fa-solid fa-calendar fa-fw"></i>
                    </span>
                    <%= date(page.date, "YYYY/M/D" ) %>
                </span>
                <% if (page.categories && page.categories.data.length !==0) { %>
                    <span class="category">
                        <a href="<%- url_for(page.categories.data[0].path) %>">
                            <span class="icon">
                                <i class="fa-solid fa-bookmark fa-fw"></i>
                            </span>
                            <%= page.categories.data[0].name %>
                        </a>
                    </span>
                    <% } %>
                        <% if (page.tags && page.tags.data.length !==0) { %>
                            <span class="tags">
                                <span class="icon">
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                </span>
                                <% let prev; %>
                                    <% page.tags.data.forEach((tag)=> { %>
                                        <span class="tag">
                                            <% const colors=theme.colors.filter((color)=> color !== prev);
                                                let id = Math.floor(Math.random() * colors.length);
                                                prev = colors[id];
                                                %>
                                                <a href="<%- url_for(tag.path) %>" style="color: <%- colors[id] %>">
                                                    <%= tag.name %>
                                                </a>
                                        </span>
                                        <% }); %>
                            </span>
                            <% } %>
            </div>
        </div>

        <% if (theme.crypto.enable && typeof page.secret !=="undefined" ) { %>
            <% const CryptoJS=getCryptoJS(); %>
                <input id="crypto" :class="['input', cryptoStatus]" :disabled="cryptoStatus === 'success'" ref="crypto"
                    placeholder="文章被加密，请输入密码"
                    data-encrypted="<%- CryptoJS.AES.encrypt(page.content, page.secret).toString() %>"
                    data-shasum="<%- CryptoJS.SHA256(page.content).toString() %>" v-model="crypto" />
                <transition name="fade">
                    <div class="content" ref="content" v-show="cryptoStatus === 'success'"></div>
                </transition>
                <% } else { %>
                    <div class="content" v-pre>
                        <%- page.content %>
                    </div>
                    <% } %>

                        <% if (page.comments) { %>
                            <% if (theme.gitalk.enable) { %>
                                <div id="comment">
                                    <div id="gitalk-container"></div>
                                </div>
                                <% } %>
                                    <% if (theme.giscus.enable) { %>
                                        <div id="comment">
                                            <div id="giscus-container" class="giscus"></div>
                                        </div>
                                        <% } %>
                                            <% if (theme.waline.enable) { %>
                                                <div id="comment">
                                                    <div id="waline-container"></div>
                                                </div>
                                                <% } %>
                                                    <% if (theme.twikoo.enable) { %>
                                                        <div id="comment">
                                                            <div id="twikoo-container"></div>
                                                        </div>
                                                        <% } %>
                                                            <% } %>
    </div>

    <!-- 右侧侧边栏（套用 article-sidebar 样式） -->
    <div class="article-sidebar">
        <!-- 相关文章模块 -->
        <div class="post-recent-article">
            <h3 class="sidebar-title">相关文章</h3>
            <div class="sidebar-content-tag-related">
                <% if (page.tags && page.tags.data.length> 0) { %>
                    <ul class="tag-related-list">
                        <% const currentTags=page.tags.data.map(tag=> tag.name);
                            const relatedPosts = new Set();
                            site.tags.data.forEach(tag => {
                            if (currentTags.includes(tag.name)) {
                            tag.posts.data.forEach(post => {
                            if (post.path !== page.path && post.published) {
                            relatedPosts.add(post);
                            }
                            });
                            }
                            });
                            const relatedPostsArr = Array.from(relatedPosts).slice(0, 5);
                            %>
                            <% if (relatedPostsArr.length> 0) { %>
                                <% relatedPostsArr.forEach(post=> { %>
                                    <li class="tag-related-item">
                                        <a href="<%- url_for(post.path) %>" title="<%= post.title %>">
                                            <%= post.title %>
                                        </a>
                                    </li>
                                    <% }); %>
                                        <% } else { %>
                                            <li class="tag-related-empty">暂无相关文章</li>
                                            <% } %>
                    </ul>
                    <% } else { %>
                        <p>本文未添加 Tag</p>
                        <% } %>
            </div>
        </div>

        <!-- 大纲模块 -->
        <div class="post-toc">
            <h3>大纲</h3>
            <% if (page.toc !==false) { %>
                <!-- 调整为 h2-h4（避免 h1 重复，更合理） -->
                <%- toc(page.content, {toc_levels: '2-4' }) %>
                    <% } else { %>
                        <p>本文未启用大纲</p>
                        <% } %>
        </div>
    </div>
</div>

<!-- 大纲滚动高亮 JS（可选，提升体验） -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tocLinks = document.querySelectorAll('.post-toc a');
        const sections = document.querySelectorAll('h2, h3, h4'); // 和大纲层级对应

        window.addEventListener('scroll', function () {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.scrollY >= sectionTop - 100) {
                    current = '#' + (section.getAttribute('id') || '');
                }
            });

            // 滚动时高亮当前大纲项
            tocLinks.forEach(link => {
                link.style.color = '#34495e';
                link.style.fontWeight = 'normal';
                if (link.getAttribute('href') === current) {
                    link.style.color = '#e74c3c';
                    link.style.fontWeight = '600';
                }
            });
        });
    });
</script>