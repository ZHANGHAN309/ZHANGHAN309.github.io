---
title: 特性和反射
date: 2025/11/11
tags: C#
categories: 技术篇
---

在 C# 中，**特性（Attribute）** 是一种特殊的声明式标签，用于向程序集（Assembly）中嵌入元数据（Metadata），描述代码元素（如类、方法、参数等）的额外信息。这些信息可以在**编译时**被编译器读取，或在**运行时**通过反射（Reflection）获取，从而实现对代码的 “标注” 和 “扩展”。

```C#
using System;

// 步骤1：通过 [AttributeUsage] 限制特性的适用范围
// 这里指定可用于类、方法、属性，且允许在一个元素上多次使用（AllowMultiple = true）
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method | AttributeTargets.Property, 
                AllowMultiple = true, // 允许重复应用
                Inherited = false)]   // 不允许派生类继承该特性
public class AuthorAttribute : Attribute  // 步骤2：继承 Attribute
{
    // 特性的属性（用于存储元数据）
    public string Name { get; }       // 作者姓名（必填，通过构造函数传入）
    public int Version { get; set; }  // 版本号（可选，通过属性设置）
    public bool IsCompleted { get; set; } = true;  // 是否完成（默认 true）

    // 步骤3：定义构造函数（用于初始化必填参数）
    public AuthorAttribute(string name)
    {
        Name = name; // 作者姓名为必填项
    }
}

// 应用到类上（传入必填的作者姓名，设置可选的版本号）
[Author("张三", Version = 1)]
public class MathTool
{
    // 应用到方法上（多次应用，因为 AllowMultiple = true）
    [Author("李四", Version = 2, IsCompleted = false)]
    [Author("王五", Version = 1)]
    public int Add(int a, int b)
    {
        return a + b;
    }

    // 应用到属性上
    [Author("张三", Version = 1)]
    public int MaxValue { get; set; } = 100;
}

public class UserService
{
    // 应用到参数
    public void Register([Required] string username)  // [Required] 是系统内置特性（验证参数必填）
    {
        // ...
    }

    // 应用到返回值（需用 [return:] 标记）
    [return: LogResult]  // 假设 LogResult 是自定义特性，用于记录返回值
    public bool Login(string username, string password)
    {
        return true;
    }
}
```



**反射**

```C#
using System;
using System.Reflection;

class Program
{
    static void Main()
    {
        // 1. 获取 MathTool 类的 Type 对象
        Type type = typeof(MathTool);

        // 2. 读取类上的 Author 特性
        Console.WriteLine("类上的特性：");
        if (type.IsDefined(typeof(AuthorAttribute), inherit: false))
        {
            // 获取所有 Author 特性（因 AllowMultiple = true，可能有多个）
            AuthorAttribute[] classAuthors = (AuthorAttribute[])type.GetCustomAttributes(typeof(AuthorAttribute), inherit: false);
            foreach (var author in classAuthors)
            {
                Console.WriteLine($"作者：{author.Name}，版本：{author.Version}，是否完成：{author.IsCompleted}");
            }
        }

        // 3. 读取 Add 方法上的 Author 特性
        Console.WriteLine("\nAdd 方法上的特性：");
        MethodInfo addMethod = type.GetMethod("Add");
        if (addMethod.IsDefined(typeof(AuthorAttribute), inherit: false))
        {
            AuthorAttribute[] methodAuthors = (AuthorAttribute[])addMethod.GetCustomAttributes(typeof(AuthorAttribute), inherit: false);
            foreach (var author in methodAuthors)
            {
                Console.WriteLine($"作者：{author.Name}，版本：{author.Version}，是否完成：{author.IsCompleted}");
            }
        }
    }
}
```

